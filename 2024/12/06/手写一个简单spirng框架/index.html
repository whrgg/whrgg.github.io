<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>手写一个简单spirng框架（一、IOC） | 旅人</title><meta name="author" content="旅人"><meta name="copyright" content="旅人"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="简介学习的是廖雪峰老师的Summer Framework项目，在这个项目中我们手写实现了一个简单的spring框架。在这个框架中，我们会实现  context模块：实现ApplicationContext容器与Bean的管理 aop模块：实现AOP功能； jdbc模块：实现JdbcTemplate，以及声明式事务管理； web模块：实现Web MVC和REST API； boot模块：实现一个简化">
<meta property="og:type" content="article">
<meta property="og:title" content="手写一个简单spirng框架（一、IOC）">
<meta property="og:url" content="http://lvren.ip-ddns.com/2024/12/06/%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95spirng%E6%A1%86%E6%9E%B6/index.html">
<meta property="og:site_name" content="旅人">
<meta property="og:description" content="简介学习的是廖雪峰老师的Summer Framework项目，在这个项目中我们手写实现了一个简单的spring框架。在这个框架中，我们会实现  context模块：实现ApplicationContext容器与Bean的管理 aop模块：实现AOP功能； jdbc模块：实现JdbcTemplate，以及声明式事务管理； web模块：实现Web MVC和REST API； boot模块：实现一个简化">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://q1.qlogo.cn/g?b=qq&nk=2186840198&s=640">
<meta property="article:published_time" content="2024-12-06T06:19:51.000Z">
<meta property="article:modified_time" content="2025-03-07T07:46:41.224Z">
<meta property="article:author" content="旅人">
<meta property="article:tag" content="架构">
<meta property="article:tag" content="spring">
<meta property="article:tag" content="进阶">
<meta property="article:tag" content="原理实现">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://q1.qlogo.cn/g?b=qq&nk=2186840198&s=640"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "手写一个简单spirng框架（一、IOC）",
  "url": "http://lvren.ip-ddns.com/2024/12/06/%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95spirng%E6%A1%86%E6%9E%B6/",
  "image": "https://q1.qlogo.cn/g?b=qq&nk=2186840198&s=640",
  "datePublished": "2024-12-06T06:19:51.000Z",
  "dateModified": "2025-03-07T07:46:41.224Z",
  "author": [
    {
      "@type": "Person",
      "name": "旅人",
      "url": "http://lvren.ip-ddns.com/"
    }
  ]
}</script><link rel="shortcut icon" href="https://traveller-img.oss-cn-shenzhen.aliyuncs.com/B2FDB3678D6ADE4257B261B0D08160C0.gif"><link rel="canonical" href="http://lvren.ip-ddns.com/2024/12/06/%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95spirng%E6%A1%86%E6%9E%B6/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '手写一个简单spirng框架（一、IOC）',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/deflaut.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://q1.qlogo.cn/g?b=qq&amp;nk=2186840198&amp;s=640" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于作者</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="https://traveller-img.oss-cn-shenzhen.aliyuncs.com/B2FDB3678D6ADE4257B261B0D08160C0.gif" alt="Logo"></a><a class="nav-page-title" href="/"><span class="site-name">手写一个简单spirng框架（一、IOC）</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa fa-graduation-cap"></i><span> 博文</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-archive"></i><span> 分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-folder-open"></i><span> 归档</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于作者</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">手写一个简单spirng框架（一、IOC）</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-12-06T06:19:51.000Z" title="发表于 2024-12-06 14:19:51">2024-12-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-07T07:46:41.224Z" title="更新于 2025-03-07 15:46:41">2025-03-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%A1%86%E6%9E%B6/">框架</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>学习的是廖雪峰老师的<a target="_blank" rel="noopener" href="https://liaoxuefeng.com/books/summerframework/introduction/index.html">Summer Framework</a>项目，在这个项目中我们手写实现了一个简单的spring框架。在这个框架中，我们会实现</p>
<ul>
<li>context模块：实现ApplicationContext容器与Bean的管理</li>
<li>aop模块：实现AOP功能；</li>
<li>jdbc模块：实现JdbcTemplate，以及声明式事务管理；</li>
<li>web模块：实现Web MVC和REST API；</li>
<li>boot模块：实现一个简化版的“Spring Boot”，用于打包运行;</li>
</ul>
<h1 id="实现ResourceResolver"><a href="#实现ResourceResolver" class="headerlink" title="实现ResourceResolver"></a>实现ResourceResolver</h1><p>spring使用容器来管理bean，但是显而易见，容器是不可能自己感知到bean是在哪里存在的，所以我们需要对整个项目的Class进行一个扫描。java的ClassLoader机制可以获取到指定的Class，但是，给出一个包名，它并不能获取到该包下的所有Class，也不能获取子包。</p>
<p>所以我们需要自己动手实现一个文件扫描的功能</p>
<p>首先创建一个文件类型</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Resource</span> &#123;</span><br><span class="line">    String path;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Resource</span><span class="params">(String path,String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.path = path;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPath</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPath</span><span class="params">(String path)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.path = path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>(<span class="string">&quot;Resource&#123;&quot;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;path=&#x27;&quot;</span>).append(path).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&quot;, name=&#x27;&quot;</span>).append(name).append(<span class="string">&#x27;\&#x27;&#x27;</span>);</span><br><span class="line">        sb.append(<span class="string">&#x27;&#125;&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在spring中提供了一个ResourceResolver类，提供一个scan方法来扫描。</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>首先要认清java中的各个路径（即资源定位与解析）</p>
<ul>
<li>URI形式的绝对路径资源</li>
<li>本地系统的绝对路径</li>
<li>相对于classpath的相对路径</li>
<li>相对于当前用户目录的相对路径·</li>
</ul>
<p>我们选择通过classpath相对路径来解析，所以要拿到ClassLoader。</p>
<p>当前线程的类加载会从classes下开启</p>
<p>主类的类加载带&#x2F;从当前类所在包路径去获取资源</p>
<p>主类的类加载不带&#x2F;从classPath的根路径开启</p>
<p><img src="https://traveller-img.oss-cn-shenzhen.aliyuncs.com/20250306200338.png" alt="getResource"></p>
<p>ClassLoader首先从Thread.getContextClassLoader()获取，如果获取不到，再从当前Class获取，因为Web应用的ClassLoader不是JVM提供的基于Classpath的ClassLoader，而是Servlet容器提供的ClassLoader，它不在默认的Classpath搜索，而是在&#x2F;WEB-INF&#x2F;classes目录和&#x2F;WEB-INF&#x2F;lib的所有jar包搜索，从Thread.getContextClassLoader()可以获取到Servlet容器专属的ClassLoader。</p>
<p>使用getResource获取文件路径URI之后，我们对URI进行编码的处理后拿到路径返回值。根据路径的头的协议来选择如何创建Resource</p>
<ul>
<li>要注意&#x2F;的处理，头或者尾的处理，以及不同系统的处理</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceResolver</span> &#123;</span><br><span class="line">    <span class="comment">//基础包名</span></span><br><span class="line">    String basePackage;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResourceResolver</span><span class="params">(String basePackage)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.basePackage = basePackage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这是对外暴露的扫描方法，接收一个 Function&lt;Resource, R&gt; 类型的映射函数 mapper，用于将扫描到的 Resource 对象转换为指定类型 R 的对象</span></span><br><span class="line">    <span class="keyword">public</span> &lt;R&gt; List&lt;R&gt; <span class="title function_">scan</span><span class="params">(Function&lt;Resource, R&gt; mapper)</span> &#123;</span><br><span class="line">        <span class="comment">//将基础包名的路径替换得到路径进行扫描</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">basePackagePath</span> <span class="operator">=</span> <span class="built_in">this</span>.basePackage.replace(<span class="string">&quot;.&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> basePackagePath;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;R&gt; collector = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            scan0(basePackagePath, path, collector, mapper);</span><br><span class="line">            <span class="keyword">return</span> collector;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UncheckedIOException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &lt;R&gt; <span class="keyword">void</span> <span class="title function_">scan0</span><span class="params">(String basePackagePath, String path, List&lt;R&gt; collector, Function&lt;Resource, R&gt; mapper)</span> <span class="keyword">throws</span> IOException, URISyntaxException &#123;</span><br><span class="line">    logger.atDebug().log(<span class="string">&quot;scan path: &#123;&#125;&quot;</span>, path);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//比较老的迭代器接口 但是属于是懒加载机制，遍历过程中可以更快地开始处理元素，不需要等待所有元素加载完成。</span></span><br><span class="line">    Enumeration&lt;URL&gt; en = getContextClassLoader().getResources(path);</span><br><span class="line">    <span class="keyword">while</span> (en.hasMoreElements()) &#123;</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> en.nextElement();</span><br><span class="line">        <span class="type">URI</span> <span class="variable">uri</span> <span class="operator">=</span> url.toURI();</span><br><span class="line">        <span class="type">String</span> <span class="variable">uriStr</span> <span class="operator">=</span> removeTrailingSlash(uriToString(uri));</span><br><span class="line">        <span class="type">String</span> <span class="variable">uriBaseStr</span> <span class="operator">=</span> uriStr.substring(<span class="number">0</span>, uriStr.length() - basePackagePath.length());</span><br><span class="line">        System.out.println(<span class="string">&quot;URL: &quot;</span> + url + <span class="string">&quot; HashCode: &quot;</span> + url.hashCode());</span><br><span class="line">        <span class="keyword">if</span> (uriBaseStr.startsWith(<span class="string">&quot;file:&quot;</span>)) &#123;</span><br><span class="line">            uriBaseStr = uriBaseStr.substring(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (uriStr.startsWith(<span class="string">&quot;jar:&quot;</span>)) &#123;</span><br><span class="line">            scanFile(<span class="literal">true</span>, uriBaseStr, jarUriToPath(basePackagePath, uri), collector, mapper);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            scanFile(<span class="literal">false</span>, uriBaseStr, Paths.get(uri), collector, mapper);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取类加载器</span></span><br><span class="line">    ClassLoader <span class="title function_">getContextClassLoader</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        cl = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (cl == <span class="literal">null</span>) &#123;</span><br><span class="line">            cl = getClass().getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> cl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//转换jar包的路径</span></span><br><span class="line">    Path <span class="title function_">jarUriToPath</span><span class="params">(String basePackagePath, URI jarUri)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> FileSystems.newFileSystem(jarUri, <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;()).getPath(basePackagePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//对文件的扫描方式</span></span><br><span class="line">    &lt;R&gt; <span class="keyword">void</span> <span class="title function_">scanFile</span><span class="params">(<span class="type">boolean</span> isJar, String base, Path root, List&lt;R&gt; collector, Function&lt;Resource, R&gt; mapper)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">baseDir</span> <span class="operator">=</span> removeTrailingSlash(base);</span><br><span class="line">        Files.walk(root).filter(Files::isRegularFile).forEach(file -&gt; &#123;</span><br><span class="line">            <span class="type">Resource</span> <span class="variable">res</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (isJar) &#123;</span><br><span class="line">                res = <span class="keyword">new</span> <span class="title class_">Resource</span>(baseDir, removeLeadingSlash(file.toString()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> file.toString();</span><br><span class="line">                <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> removeLeadingSlash(path.substring(baseDir.length()));</span><br><span class="line">                res = <span class="keyword">new</span> <span class="title class_">Resource</span>(<span class="string">&quot;file:&quot;</span> + path, name);</span><br><span class="line">            &#125;</span><br><span class="line">            logger.atDebug().log(<span class="string">&quot;found resource: &#123;&#125;&quot;</span>, res);</span><br><span class="line">            <span class="type">R</span> <span class="variable">r</span> <span class="operator">=</span> mapper.apply(res);</span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">                collector.add(r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//转换url的路径</span></span><br><span class="line">    String <span class="title function_">uriToString</span><span class="params">(URI uri)</span> <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">        <span class="keyword">return</span> URLDecoder.decode(uri.toString(), String.valueOf(StandardCharsets.UTF_8));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//移除开始的/</span></span><br><span class="line">    String <span class="title function_">removeLeadingSlash</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.startsWith(<span class="string">&quot;/&quot;</span>) || s.startsWith(<span class="string">&quot;\\&quot;</span>)) &#123;</span><br><span class="line">            s = s.substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//移除最后的/</span></span><br><span class="line">    String <span class="title function_">removeTrailingSlash</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.endsWith(<span class="string">&quot;/&quot;</span>) || s.endsWith(<span class="string">&quot;\\&quot;</span>)) &#123;</span><br><span class="line">            s = s.substring(<span class="number">0</span>, s.length() - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实现PropertyResolver"><a href="#实现PropertyResolver" class="headerlink" title="实现PropertyResolver"></a>实现PropertyResolver</h1><p>即实现@Autowired，@Value<br>我们在这里实现的@Autowired，涉及到Bean的依赖，而对于@Value，则仅仅是将对应的配置注入<br>支持，我们首先实现@Value。<br>支持3种注入方式：</p>
<ul>
<li>按配置的key查询，例如：getProperty(“app.title”)</li>
<li>以${abc.xyz}形式的查询</li>
<li>带默认值的，以${abc.xyz:defaultValue}形式的查询</li>
</ul>
<h2 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h2><p>@Value要支持配置文件的注入，所以要配置上扫描配置文件。将文件内容存入方便查找。<br>同时也要有一个字符的解析器，方便解析abc.xyz:defaultValue的内容来注入</p>
<p>解析的时候也要注意不带${}的注入即普通key的处理<br>同时也要注意对${key:${value}}这种的解析所以当我们解析拿到值之后还要调用一次处理值的方法</p>
<p>值得注意的是，真正的spring中涉及到了很复杂的语言解析，这部分的内容要靠专业知识去补充了，目前解析就支持到这里吧</p>
<h2 id="部分实现"><a href="#部分实现" class="headerlink" title="部分实现"></a>部分实现</h2><p>java自带着对key-value查询的Properties</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PropertyResolver</span> &#123;</span><br><span class="line">    </span><br><span class="line">    Map&lt;String, String&gt; properties = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PropertyResolver</span><span class="params">(Properties props)</span> &#123;</span><br><span class="line">        <span class="comment">// 存入环境变量:即计算机系统的环境变量</span></span><br><span class="line">        <span class="built_in">this</span>.properties.putAll(System.getenv());</span><br><span class="line">        <span class="comment">// 存入Properties:</span></span><br><span class="line">        Set&lt;String&gt; names = props.stringPropertyNames();</span><br><span class="line">        <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">            <span class="built_in">this</span>.properties.put(name, props.getProperty(name));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加入根据键获取值的方法</span></span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先解析${abc.xyz:defaultValue}这种类型的key</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//先定义一个解析表达式的存储类</span></span><br><span class="line"><span class="keyword">record</span> <span class="title class_">PropertyExpr</span><span class="params">(String key, String defaultValue)</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//解析字符</span></span><br><span class="line">PropertyExpr <span class="title function_">parsePropertyExpr</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key.startsWith(<span class="string">&quot;$&#123;&quot;</span>) &amp;&amp; key.endsWith(<span class="string">&quot;&#125;&quot;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 是否存在defaultValue?</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> key.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (n == (-<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="comment">// 没有defaultValue: $&#123;key&#125;</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">k</span> <span class="operator">=</span> key.substring(<span class="number">2</span>, key.length() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PropertyExpr</span>(k, <span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 有defaultValue: $&#123;key:default&#125;</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">k</span> <span class="operator">=</span> key.substring(<span class="number">2</span>, n);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PropertyExpr</span>(k, key.substring(n + <span class="number">1</span>, key.length() - <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取值的代码</span></span><br><span class="line"></span><br><span class="line">~~~java</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getProperty</span><span class="params">(String key,String defaultValue)</span> &#123;&#125;</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getProperty</span><span class="params">(String key)</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="值转换"><a href="#值转换" class="headerlink" title="值转换"></a>值转换</h3><p>除了String类型外，@Value注入时，还允许boolean、int、Long等基本类型和包装类型。此外，Spring还支持Date、Duration等类型的注入。我们既要实现类型转换，又不能写死，否则，将来支持新的类型时就要改代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">getProperty</span><span class="params">(String key, Class&lt;T&gt; targetType)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> getProperty(key);</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 转换为指定类型:</span></span><br><span class="line">    <span class="keyword">return</span> convert(targetType, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于类型转换，实际上是从String转换为指定类型，因此，用函数式接口Function&lt;String, Object&gt;就很合适：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 转换到指定Class类型:</span></span><br><span class="line">    &lt;T&gt; T <span class="title function_">convert</span><span class="params">(Class&lt;?&gt; clazz, String value)</span> &#123;</span><br><span class="line">        Function&lt;String, Object&gt; fn = <span class="built_in">this</span>.converters.get(clazz);</span><br><span class="line">        <span class="keyword">if</span> (fn == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Unsupported value type: &quot;</span> + clazz.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) fn.apply(value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>各种要转换的类型要存放</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">PropertyResolver</span><span class="params">(Properties props)</span> &#123;</span><br><span class="line">    <span class="comment">// String类型:</span></span><br><span class="line">    converters.put(String.class, s -&gt; s);</span><br><span class="line">    <span class="comment">// boolean类型:</span></span><br><span class="line">    converters.put(<span class="type">boolean</span>.class, s -&gt; Boolean.parseBoolean(s));</span><br><span class="line">    converters.put(Boolean.class, s -&gt; Boolean.valueOf(s));</span><br><span class="line">    <span class="comment">// int类型:</span></span><br><span class="line">    converters.put(<span class="type">int</span>.class, s -&gt; Integer.parseInt(s));</span><br><span class="line">    converters.put(Integer.class, s -&gt; Integer.valueOf(s));</span><br><span class="line">    <span class="comment">// 其他基本类型...</span></span><br><span class="line">    <span class="comment">// Date/Time类型:</span></span><br><span class="line">    converters.put(LocalDate.class, s -&gt; LocalDate.parse(s));</span><br><span class="line">    converters.put(LocalTime.class, s -&gt; LocalTime.parse(s));</span><br><span class="line">    converters.put(LocalDateTime.class, s -&gt; LocalDateTime.parse(s));</span><br><span class="line">    converters.put(ZonedDateTime.class, s -&gt; ZonedDateTime.parse(s));</span><br><span class="line">    converters.put(Duration.class, s -&gt; Duration.parse(s));</span><br><span class="line">    converters.put(ZoneId.class, s -&gt; ZoneId.of(s));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="集成YAML配置"><a href="#集成YAML配置" class="headerlink" title="集成YAML配置"></a>集成YAML配置</h3><p>首先引入依赖org.yaml:snakeyaml:2.0，通过YamlUtils返回Map并且和properties的集合起来</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">YamlUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title function_">loadYamlAsPlainMap</span><span class="params">(String path)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="创建BeanDefinition"><a href="#创建BeanDefinition" class="headerlink" title="创建BeanDefinition"></a>创建BeanDefinition</h1><p>在此之前，我们实现了ResourceResolver扫描Class，并且通过PropertyResolver获取配置，接下来就可以开始着手实现IOC了</p>
<h2 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h2><p>BeanDefinition是用来记录bean信息的类，作为IOC，有着管理所有bean，即实例的生命周期。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanDefinition</span> &#123;</span><br><span class="line">    <span class="comment">// 全局唯一的Bean Name:</span></span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bean的声明类型:</span></span><br><span class="line">    Class&lt;?&gt; beanClass;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bean的实例:</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造方法/null:</span></span><br><span class="line">    Constructor&lt;?&gt; constructor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工厂方法名称/null:</span></span><br><span class="line">    String factoryName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 工厂方法/null:</span></span><br><span class="line">    Method factoryMethod;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Bean的顺序:</span></span><br><span class="line">    <span class="type">int</span> order;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否标识@Primary:</span></span><br><span class="line">    <span class="type">boolean</span> primary;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// init/destroy方法名称:</span></span><br><span class="line">    String initMethodName;</span><br><span class="line">    String destroyMethodName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// init/destroy方法:</span></span><br><span class="line">    Method initMethod;</span><br><span class="line">    Method destroyMethod;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于自己定义的带@Component注解的Bean，我们需要获取Class类型，获取构造方法来创建Bean，然后收集@PostConstruct和@PreDestroy标注的初始化与销毁的方法，以及其他信息，如@Order定义Bean的内部排序顺序，@Primary定义存在多个相同类型时返回哪个“主要”Bean。一个典型的定义如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于@Configuration定义的@Bean方法，我们把它看作Bean的工厂方法，我们需要获取方法返回值作为Class类型，方法本身作为创建Bean的factoryMethod，然后收集@Bean定义的initMethod和destroyMethod标识的初始化于销毁的方法名，以及其他@Order、@Primary等信息。典型：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(initMethod=&quot;init&quot;, destroyMethod=&quot;close&quot;)</span></span><br><span class="line">    DataSource <span class="title function_">createDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>一定要区分@Component和@Bean，对于用@Bean工厂方法创建的Bean，它的声明类型与实际类型不一定是同一类型。上述createDataSource()定义的Bean，声明类型是DataSource，实际类型却是某个子类，例如HikariDataSource，因此要特别注意，我们在BeanDefinition中，存储的beanClass是声明类型，实际类型不必存储，因为可以通过instance.getClass()获得
</code></pre>
<blockquote>
<p>在spring中分为按类型注入和按名称注入，按名称注入很简单，因为一个名字不会对应多个bean，而对于按类型来说，会有同父类的，这个时候就不知道该注入到什么了，所以需要@Primary来确定一个主要的bean，在多个同类型的时候选择这个主类注入</p>
</blockquote>
<p>所以我们首先写出一个找出所有类型的方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 根据Type查找若干个BeanDefinition，返回0个或多个:</span></span><br><span class="line">List&lt;BeanDefinition&gt; <span class="title function_">findBeanDefinitions</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.beans.values().stream()</span><br><span class="line">        <span class="comment">// 按类型过滤:</span></span><br><span class="line">        .filter(def -&gt; type.isAssignableFrom(def.getBeanClass()))</span><br><span class="line">        <span class="comment">// 排序:</span></span><br><span class="line">        .sorted().collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述只是查找了所有的BeanDefinition,我们还要对多个bean@Primary的进行过滤</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> BeanDefinition <span class="title function_">findBeanDefinition</span><span class="params">(Class&lt;?&gt; type)</span> &#123;</span><br><span class="line">    List&lt;BeanDefinition&gt; defs = findBeanDefinitions(type);</span><br><span class="line">    <span class="keyword">if</span> (defs.isEmpty()) &#123; <span class="comment">// 没有找到任何BeanDefinition</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (defs.size() == <span class="number">1</span>) &#123; <span class="comment">// 找到唯一一个</span></span><br><span class="line">        <span class="keyword">return</span> defs.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 多于一个时，查找@Primary:</span></span><br><span class="line">    List&lt;BeanDefinition&gt; primaryDefs = defs.stream().filter(def -&gt; def.isPrimary()).collect(Collectors.toList());</span><br><span class="line">    <span class="keyword">if</span> (primaryDefs.size() == <span class="number">1</span>) &#123; <span class="comment">// @Primary唯一</span></span><br><span class="line">        <span class="keyword">return</span> primaryDefs.get(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (primaryDefs.isEmpty()) &#123; <span class="comment">// 不存在@Primary</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoUniqueBeanDefinitionException</span>(String.format(<span class="string">&quot;Multiple bean with type &#x27;%s&#x27; found, but no @Primary specified.&quot;</span>, type.getName()));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// @Primary不唯一</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoUniqueBeanDefinitionException</span>(String.format(<span class="string">&quot;Multiple bean with type &#x27;%s&#x27; found, and multiple @Primary specified.&quot;</span>, type.getName()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面定义好了简单的方法，下面要开始注入所有的BeanDefinition的信息。</p>
<p>首先，我们要使用以前定义的scan扫描指定包下的所有Class，然后返回Class的名字</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//首先，我们要获取到@ComponentScan注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;A <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; A <span class="title function_">findAnnotation</span><span class="params">(Class&lt;?&gt; target, Class&lt;A&gt; annoClass)</span> &#123;</span><br><span class="line">        <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> target.getAnnotation(annoClass);</span><br><span class="line">        <span class="keyword">for</span> (Annotation anno : target.getAnnotations()) &#123;</span><br><span class="line">            Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; annoType = anno.annotationType();</span><br><span class="line">            <span class="keyword">if</span> (!annoType.getPackage().getName().equals(<span class="string">&quot;java.lang.annotation&quot;</span>)) &#123;</span><br><span class="line">                <span class="type">A</span> <span class="variable">found</span> <span class="operator">=</span> findAnnotation(annoType, annoClass);<span class="comment">//在类的注解中找到了Component 又在注解的注解中找到了Component</span></span><br><span class="line">                <span class="keyword">if</span> (found != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (a != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionException</span>(<span class="string">&quot;Duplicate @&quot;</span> + annoClass.getSimpleName() + <span class="string">&quot; found on class &quot;</span> + target.getSimpleName());</span><br><span class="line">                    &#125;</span><br><span class="line">                    a = found;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">findAnnotation(主类，ComponentScan.class)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Set&lt;String&gt; <span class="title function_">scanForClassNames</span><span class="params">(Class&lt;?&gt; configClass)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取@ComponentScan注解:</span></span><br><span class="line">    <span class="type">ComponentScan</span> <span class="variable">scan</span> <span class="operator">=</span> ClassUtils.findAnnotation(configClass, ComponentScan.class);</span><br><span class="line">    <span class="comment">// 获取注解配置的package名字,未配置则默认当前类所在包:</span></span><br><span class="line">    String[] scanPackages = scan == <span class="literal">null</span> || scan.value().length == <span class="number">0</span> ? <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; configClass.getPackage().getName() &#125; : scan.value();</span><br><span class="line"></span><br><span class="line">    Set&lt;String&gt; classNameSet = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 依次扫描所有包:</span></span><br><span class="line">    <span class="keyword">for</span> (String pkg : scanPackages) &#123;</span><br><span class="line">        logger.atDebug().log(<span class="string">&quot;scan package: &#123;&#125;&quot;</span>, pkg);</span><br><span class="line">        <span class="comment">// 扫描一个包:</span></span><br><span class="line">        <span class="type">var</span> <span class="variable">rr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceResolver</span>(pkg);</span><br><span class="line">        List&lt;String&gt; classList = rr.scan(res -&gt; &#123;</span><br><span class="line">            <span class="comment">// 遇到以.class结尾的文件，就将其转换为Class全名:</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> res.name();</span><br><span class="line">            <span class="keyword">if</span> (name.endsWith(<span class="string">&quot;.class&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> name.substring(<span class="number">0</span>, name.length() - <span class="number">6</span>).replace(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;.&quot;</span>).replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 扫描结果添加到Set:</span></span><br><span class="line">        classNameSet.addAll(classList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 继续查找@Import(Xyz.class)导入的Class配置:</span></span><br><span class="line">    <span class="type">Import</span> <span class="variable">importConfig</span> <span class="operator">=</span> configClass.getAnnotation(Import.class);</span><br><span class="line">    <span class="keyword">if</span> (importConfig != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; importConfigClass : importConfig.value()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">importClassName</span> <span class="operator">=</span> importConfigClass.getName();</span><br><span class="line">            classNameSet.add(importClassName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> classNameSet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在查找到所有的类名称之后，开始对这些类进行处理，将这些注解的各种信息注入到BeanDefinition中去，<br>在扫描@Component的时候要注意他的拓展，因为@Controller这些都是@Component的拓展。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;String, BeanDefinition&gt; <span class="title function_">createBeanDefinitions</span><span class="params">(Set&lt;String&gt; classNameSet)</span> &#123;</span><br><span class="line">    Map&lt;String, BeanDefinition&gt; defs = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String className : classNameSet) &#123;</span><br><span class="line">        <span class="comment">// 获取Class:</span></span><br><span class="line">        Class&lt;?&gt; clazz = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clazz = Class.forName(className);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 是否标注@Component?</span></span><br><span class="line">        <span class="type">Component</span> <span class="variable">component</span> <span class="operator">=</span> ClassUtils.findAnnotation(clazz, Component.class);</span><br><span class="line">        <span class="keyword">if</span> (component != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取Bean的名称:</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> ClassUtils.getBeanName(clazz);</span><br><span class="line">            <span class="type">var</span> <span class="variable">def</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(</span><br><span class="line">                beanName, clazz, getSuitableConstructor(clazz),</span><br><span class="line">                getOrder(clazz), clazz.isAnnotationPresent(Primary.class),</span><br><span class="line">                <span class="comment">// init/destroy方法名称:</span></span><br><span class="line">                <span class="literal">null</span>, <span class="literal">null</span>,</span><br><span class="line">                <span class="comment">// 查找@PostConstruct方法:</span></span><br><span class="line">                ClassUtils.findAnnotationMethod(clazz, PostConstruct.class),</span><br><span class="line">                <span class="comment">// 查找@PreDestroy方法:</span></span><br><span class="line">                ClassUtils.findAnnotationMethod(clazz, PreDestroy.class));</span><br><span class="line">            addBeanDefinitions(defs, def);</span><br><span class="line">            <span class="comment">// 查找是否有@Configuration:</span></span><br><span class="line">            <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> ClassUtils.findAnnotation(clazz, Configuration.class);</span><br><span class="line">            <span class="keyword">if</span> (configuration != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 查找@Bean方法:</span></span><br><span class="line">                scanFactoryMethods(beanName, clazz, defs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> defs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而对于@Configuration的Class，我们将他们视为是一个工厂类，用于创建普通类的，我们实现一个scanFactoryMethods方法来处理这些类，将带@Bean的方法提取出来</p>
<p>关于getBeanName方法要注意，1.@Component是可以指定bean的名称的，2.没有@Component的要注意是否有@Component的拓展注解。3.都没有就返回类名</p>
<pre><code>同时，在注入信息的时候，我们注意到工厂方法中的@Bean是没有办法获取到init和destroy方法的，只能通过@Bean(initMethod = &quot;init&quot;, destroyMethod = &quot;destroy&quot;)指定的名称以及getMethod方法去调用。所以bean的方法名称和方法相关信息至少有一个是空的。
</code></pre>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">scanFactoryMethods</span><span class="params">(String factoryBeanName, Class&lt;?&gt; clazz, Map&lt;String, BeanDefinition&gt; defs)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Method method : clazz.getDeclaredMethods()) &#123;</span><br><span class="line">        <span class="comment">// 是否带有@Bean标注:</span></span><br><span class="line">        <span class="type">Bean</span> <span class="variable">bean</span> <span class="operator">=</span> method.getAnnotation(Bean.class);</span><br><span class="line">        <span class="keyword">if</span> (bean != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Bean的声明类型是方法返回类型:</span></span><br><span class="line">            Class&lt;?&gt; beanClass = method.getReturnType();</span><br><span class="line">            <span class="type">var</span> <span class="variable">def</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinition</span>(</span><br><span class="line">                ClassUtils.getBeanName(method), beanClass,</span><br><span class="line">                factoryBeanName,</span><br><span class="line">                <span class="comment">// 创建Bean的工厂方法:</span></span><br><span class="line">                method,</span><br><span class="line">                <span class="comment">// @Order</span></span><br><span class="line">                getOrder(method),</span><br><span class="line">                <span class="comment">// 是否存在@Primary标注?</span></span><br><span class="line">                method.isAnnotationPresent(Primary.class),</span><br><span class="line">                <span class="comment">// init方法名称:</span></span><br><span class="line">                bean.initMethod().isEmpty() ? <span class="literal">null</span> : bean.initMethod(),</span><br><span class="line">                <span class="comment">// destroy方法名称:</span></span><br><span class="line">                bean.destroyMethod().isEmpty() ? <span class="literal">null</span> : bean.destroyMethod(),</span><br><span class="line">                <span class="comment">// @PostConstruct / @PreDestroy方法:</span></span><br><span class="line">                <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            addBeanDefinitions(defs, def);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="完成bean的实例化"><a href="#完成bean的实例化" class="headerlink" title="完成bean的实例化"></a>完成bean的实例化</h1><p>在拿到所有的beanDefinition之后，我们便可以开始完成bean的实例化了，即在ioc容器中完成new objct这一步。</p>
<p>根据分析bean的依赖注入有四种模式</p>
<pre><code>对于构造方法和工厂方法这种类型的，因为在bena的实例化过程中，一定需要用到依赖注入，所以这种我们称之为强依赖。
而对于3，4这两种方法的，我们称之为弱依赖，因为可以先new再将属性注入进去，但是在1，2中new的过程就需要注入了
</code></pre>
<ol>
<li>构造方法注入，注入到参数中国</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Hello</span><span class="params">(<span class="meta">@Autowired</span> JdbcTemplate jdbcTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>工厂方法注入注入到bean的参数中，一般不会写@Autowire</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Hello <span class="title function_">hello</span><span class="params">(<span class="meta">@Autowired</span> JdbcTemplate jdbcTemplate)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Hello</span>(jdbcTemplate);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>Setter方法注入</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setJdbcTemplate</span><span class="params">(JdbcTemplate jdbcTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>字段注入(最常用)</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    JdbcTemplate jdbcTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h2><p>我们先解决强依赖的问题，在上一节中，我们获得了所有bean的资料，这时我们需要先检测循环依赖的问题。对于检测是否重复的问题，我们一般选择的是使用数据结构set集合。</p>
<p>我们创建一个set集合用来记住bean的名字，因为名字是多一对应的。</p>
<p>我们创建一个方法createBeanAsEarlySingleton()来检测bean循环以及做早期的实例创建</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">createBeanAsEarlySingleton</span><span class="params">(BeanDefinition def)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.creatingBeanNames.add(def.getName())) &#123;</span><br><span class="line">        <span class="comment">// 检测到重复创建Bean导致的循环依赖:</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsatisfiedDependencyException</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于接下来的实例化，我们会选择先实例化带@Configuration的工厂类，因为只有实例化工厂类之后，接下来bean的内容才有机会完全实例化。</p>
<p>使用流式来过滤list&lt; BeanDifination &gt;中的集合,找到带@Configuration的工厂，并且实例化它，实例化完工厂之后，才有机会实例化其余的内容</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="built_in">this</span>.beans.values().stream()</span><br><span class="line">            <span class="comment">// 过滤出@Configuration:</span></span><br><span class="line">            .filter(<span class="built_in">this</span>::isConfigurationDefinition).sorted().map(def -&gt; &#123;</span><br><span class="line">                <span class="comment">// 创建Bean实例:</span></span><br><span class="line">                createBeanAsEarlySingleton(def);</span><br><span class="line">                <span class="keyword">return</span> def.getName();</span><br><span class="line">            &#125;).collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建其他普通Bean:</span></span><br><span class="line">    List&lt;BeanDefinition&gt; defs = <span class="built_in">this</span>.beans.values().stream()</span><br><span class="line">            <span class="comment">// 过滤出instance==null的BeanDefinition:</span></span><br><span class="line">            .filter(def -&gt; def.getInstance() == <span class="literal">null</span>)</span><br><span class="line">            .sorted().collect(Collectors.toList());</span><br><span class="line"><span class="comment">// 依次创建Bean实例:</span></span><br><span class="line">    defs.forEach(def -&gt; &#123;</span><br><span class="line">        <span class="comment">// 如果Bean未被创建(可能在其他Bean的构造方法注入前被创建):</span></span><br><span class="line">        <span class="keyword">if</span> (def.getInstance() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建Bean:</span></span><br><span class="line">            createBeanAsEarlySingleton(def);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>接下来完善createBeanAsEarlySingleton的内容，我们从上可以知道，无论是普通bean还是工厂bean的创建，都是调用createBeanAsEarlySingleton完成的，所以我们的createBeanAsEarlySingleton方法两种情况都要支持</p>
<ol>
<li>工厂bean，工厂bean的构造方法参数不能使用@Autowired，否则会导致代理的失效以及其他问题，且工厂bean的参数要带有@value或者@Autowired之间的一个</li>
<li>注意优先使用工厂bean创建bean，这也符合我们在日常使用spring时的方式，因为在工厂中我们会对bean进行配置。</li>
<li>同时在bean未初始化时候要注意递归调用</li>
</ol>
<p>然后使用反射完成方法的创建方法的调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//建造方法调用</span></span><br><span class="line">instance = def.getConstructor().newInstance(args);</span><br><span class="line"><span class="comment">//或者是</span></span><br><span class="line"><span class="comment">//先拿到工厂方法的实例</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">configInstance</span> <span class="operator">=</span> getBean(def.getFactoryName());</span><br><span class="line">instance = def.getFactoryMethod().invoke(configInstance, args);</span><br></pre></td></tr></table></figure>

<p>自此我们完成了创建Bean的实例，并且实现了强依赖的注入，接下来便是对Bean进行初始化的内容，也就是弱依赖的注入</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://lvren.ip-ddns.com">旅人</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://lvren.ip-ddns.com/2024/12/06/%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95spirng%E6%A1%86%E6%9E%B6/">http://lvren.ip-ddns.com/2024/12/06/手写一个简单spirng框架/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://lvren.ip-ddns.com" target="_blank">旅人</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%9E%B6%E6%9E%84/">架构</a><a class="post-meta__tags" href="/tags/spring/">spring</a><a class="post-meta__tags" href="/tags/%E8%BF%9B%E9%98%B6/">进阶</a><a class="post-meta__tags" href="/tags/%E5%8E%9F%E7%90%86%E5%AE%9E%E7%8E%B0/">原理实现</a></div><div class="post-share"><div class="social-share" data-image="https://q1.qlogo.cn/g?b=qq&amp;nk=2186840198&amp;s=640" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/11/21/git%E5%BE%AE%E8%BF%9B%E9%98%B6/" title="git微进阶"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">git微进阶</div></div><div class="info-2"><div class="info-item-1">git微进阶技巧作为程序员git属于是我们工作生活中的一个必备技能，但是看过网上的大部分教程后，基本上还是只会git pull和git push...</div></div></div></a><a class="pagination-related" href="/2024/12/08/%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84spring%E6%A1%86%E6%9E%B6-%E4%BA%8C%E3%80%81IOC/" title="手写一个简单的spring框架(二、IOC)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">手写一个简单的spring框架(二、IOC)</div></div><div class="info-2"><div class="info-item-1">初始化bean思路在上一节我们实现了bean的强依赖注入，接下来我们要实现的便是弱依赖的注入，也就是字段和setter方法的注入。我们首先进行注入，但是不进行init的使用 // 在当前类及父类进行字段和方法注入:void injectProperties(BeanDefinition def, Class&lt;?&gt; clazz, Object bean) &#123;    // 在当前类查找Field和Method并注入:    for (Field f : clazz.getDeclaredFields()) &#123;        tryInjectProperties(def, clazz, bean, f);    &#125;    for (Method m : clazz.getDeclaredMethods()) &#123;        tryInjectProperties(def, clazz, bean, m);    &#125;    // 在父类查找Field和Method并注入:    Class&lt;?&gt;...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2024/12/08/%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84spring%E6%A1%86%E6%9E%B6-%E4%BA%8C%E3%80%81IOC/" title="手写一个简单的spring框架(二、IOC)"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-12-08</div><div class="info-item-2">手写一个简单的spring框架(二、IOC)</div></div><div class="info-2"><div class="info-item-1">初始化bean思路在上一节我们实现了bean的强依赖注入，接下来我们要实现的便是弱依赖的注入，也就是字段和setter方法的注入。我们首先进行注入，但是不进行init的使用 // 在当前类及父类进行字段和方法注入:void injectProperties(BeanDefinition def, Class&lt;?&gt; clazz, Object bean) &#123;    // 在当前类查找Field和Method并注入:    for (Field f : clazz.getDeclaredFields()) &#123;        tryInjectProperties(def, clazz, bean, f);    &#125;    for (Method m : clazz.getDeclaredMethods()) &#123;        tryInjectProperties(def, clazz, bean, m);    &#125;    // 在父类查找Field和Method并注入:    Class&lt;?&gt;...</div></div></div></a><a class="pagination-related" href="/2025/02/15/DDIA%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/" title="DDIA第一部分"><img class="cover" src="https://traveller-img.oss-cn-shenzhen.aliyuncs.com/20250305125903.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-15</div><div class="info-item-2">DDIA第一部分</div></div><div class="info-2"><div class="info-item-1">什么是数据库原始数据库最基本的功能：将数据存入库 和 将数据从库里取出 数据结构的处理由此引出了我们存入库和取出库时对于数据结构的处理 分为了静态与动态处理  静态:如mysql 存进去的时候就已经限定好了一个是一个二维的对象 动态:如文档型数据库 里边的内容拿出来的时候要自定义解析的情况  如何存储世界上最简单的数据库#!/bin/bashdb_set () &#123;  echo &quot;$1,$2&quot; &gt;&gt; database&#125;db_get () &#123;  grep &quot;^$1,&quot; database | sed -e &quot;s/^$1,//&quot; | tail -n...</div></div></div></a><a class="pagination-related" href="/2024/06/09/spring/" title="spring"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-06-09</div><div class="info-item-2">spring</div></div><div class="info-2"><div class="info-item-1">spring是什么  Core Container这个模块是spring框架中最核心的部分，其他所有模块都是依赖它运行的。看到容器（装对象的），根据这样的一个结构设计来看，spirng是用来管对象的技术 是AOP(面向切面编程)模块设计型的概念。具体是做什么的呢？它可以在不惊动原始程序的基础上，给它增强功能，aspect也是对aop思想进行了实现 Data Access 是和我们与数据库交互相关的内容 web 和spring mvc相关 test 用于快速测试，单例测试：就是对一个一个的方法进行测试的模式  核心概念IOC控制反转&#x2F;DI在controller中要使用Service 所以我们需要由既要创建controller，又要使得controller创建的时候要带上Service，将controller内部加上Service的过程就是DI（依赖注入） 配置文件注入方式id是方便IOC容器查找的class指明这个类在项目中的位置 &lt;?xml version=&quot;1.0&quot;...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://q1.qlogo.cn/g?b=qq&amp;nk=2186840198&amp;s=640" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">旅人</div><div class="author-info-description">技术栈也是栈</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">16</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/whrgg"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来到我的博客休息</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0ResourceResolver"><span class="toc-text">实现ResourceResolver</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-text">思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0PropertyResolver"><span class="toc-text">实现PropertyResolver</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-1"><span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E5%88%86%E5%AE%9E%E7%8E%B0"><span class="toc-text">部分实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%80%BC%E8%BD%AC%E6%8D%A2"><span class="toc-text">值转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90YAML%E9%85%8D%E7%BD%AE"><span class="toc-text">集成YAML配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%9B%E5%BB%BABeanDefinition"><span class="toc-text">创建BeanDefinition</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-2"><span class="toc-text">思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%8C%E6%88%90bean%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-text">完成bean的实例化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-3"><span class="toc-text">思路</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/02/15/DDIA%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/" title="DDIA第一部分"><img src="https://traveller-img.oss-cn-shenzhen.aliyuncs.com/20250305125903.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DDIA第一部分"/></a><div class="content"><a class="title" href="/2025/02/15/DDIA%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86/" title="DDIA第一部分">DDIA第一部分</a><time datetime="2025-02-15T03:53:41.000Z" title="发表于 2025-02-15 11:53:41">2025-02-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/08/%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84spring%E6%A1%86%E6%9E%B6-%E4%BA%8C%E3%80%81IOC/" title="手写一个简单的spring框架(二、IOC)">手写一个简单的spring框架(二、IOC)</a><time datetime="2024-12-08T07:47:28.000Z" title="发表于 2024-12-08 15:47:28">2024-12-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/12/06/%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95spirng%E6%A1%86%E6%9E%B6/" title="手写一个简单spirng框架（一、IOC）">手写一个简单spirng框架（一、IOC）</a><time datetime="2024-12-06T06:19:51.000Z" title="发表于 2024-12-06 14:19:51">2024-12-06</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/11/21/git%E5%BE%AE%E8%BF%9B%E9%98%B6/" title="git微进阶">git微进阶</a><time datetime="2024-11-20T16:35:25.000Z" title="发表于 2024-11-21 00:35:25">2024-11-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/17/github%E5%AE%9E%E7%8E%B0CD/" title="github实现CD">github实现CD</a><time datetime="2024-08-16T16:28:02.000Z" title="发表于 2024-08-17 00:28:02">2024-08-17</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/foot.jpg);"><div id="footer-wrap"><div class="copyright">&copy;1 - 2025 By 旅人</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>